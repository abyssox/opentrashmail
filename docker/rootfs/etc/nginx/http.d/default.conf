log_format otm '[$time_local] [Nginx] '
               '$remote_addr "$request" $status $body_bytes_sent '
               '"$http_referer" "$http_user_agent"';

server {
    listen 80 default_server;
    server_name _;

    set $base /var/www/opentrashmail;
    root $base/public;
    index index.php;

    client_max_body_size 20M;

    access_log /var/www/opentrashmail/logs/web.access.log otm;
    error_log  /var/www/opentrashmail/logs/web.error.log warn;

    location ~ /\. {
        deny all;
    }

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /index.php {
        include fastcgi_params;

        fastcgi_pass   127.0.0.1:9000;
        fastcgi_index  index.php;

        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT   $realpath_root;
        fastcgi_param PHP_ADMIN_VALUE "open_basedir=$base/:/usr/lib/php/:/tmp/";

        fastcgi_buffers      8 16k;
        fastcgi_buffer_size  32k;
        fastcgi_read_timeout 60s;
    }

    location ~ \.php$ {
        deny all;
    }

    # ------------------------------------------------------------------
    # Security headers
    #
    # NOTE: These are commented out because this container is expected
    # to run behind an external reverse proxy, which already sets
    # security headers.
    #
    # If you ever expose this container directly to the internet,
    # you should **uncomment** the lines below so clients get proper
    # security headers.
    # ------------------------------------------------------------------
    # add_header X-Frame-Options "SAMEORIGIN" always;
    # add_header X-Content-Type-Options "nosniff" always;
    # add_header Referrer-Policy "no-referrer-when-cross-origin" always;
    # add_header Content-Security-Policy "default-src 'self' data: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'self';" always;

    # ------------------------------------------------------------------
    # gzip
    #
    # NOTE: gzip is disabled here because compression is handled
    # by the reverse proxy in front of this container.
    # If you expose this container directly, you can enable it again.
    # ------------------------------------------------------------------
    # gzip on;
    # gzip_vary on;
    # gzip_proxied any;
    # gzip_comp_level 6;
    # gzip_types
    #     text/plain
    #     text/css
    #     text/xml
    #     application/json
    #     application/javascript
    #     application/xml+rss
    #     application/atom+xml
    #     image/svg+xml;
}
